<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.macademy.shop.main.mapper.OrderMapper">
    <insert id="insertOrder" parameterType="orderDto"
            useGeneratedKeys="true" keyProperty="orderId" keyColumn="order_id">
        INSERT INTO orders (member_id,order_status)
        VALUES (#{memberId},#{orderStatus})
    </insert>
    <insert id="insertOrderItem" parameterType="orderItemDto"
            useGeneratedKeys="true" keyProperty="orderItemId" keyColumn="order_item_id">
        INSERT INTO order_item(order_id,item_id,order_price,count)
        VALUES (#{orderId},#{itemId},#{orderPrice},#{count})

    </insert>
    <update id="changeStock">
        UPDATE item
        SET stock_number = #{stockNumber}
        WHERE item_id=#{itemId}
    </update>
    <select id="orderSelect">
        SELECT  o.order_id, o.member_id,o.order_date,o.order_status,i.item_name,
                i.item_id,oi.order_price,oi.count,ii.img_url
        FROM    orders o JOIN order_item oi ON o.order_id = oi.order_id
                         JOIN item i        ON oi.item_id = i.item_id
                         JOIN item_img ii   ON i.item_id = ii.item_id
        WHERE   o.member_id=#{memberId} AND ii.rep_img_yn='Y'
        ORDER BY o.order_date DESC
        LIMIT #{pageSize} OFFSET #{offset};
    </select>
    <select id="orderCount" resultType="int" parameterType="map">
        SELECT  count(*)
        FROM    orders o JOIN order_item oi ON o.order_id = oi.order_id
        JOIN item i        ON oi.item_id = i.item_id
        JOIN item_img ii   ON i.item_id = ii.item_id
        WHERE   o.member_id=#{memberId} AND ii.rep_img_yn='Y';
    </select>
</mapper>